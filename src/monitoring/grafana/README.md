# Мониторинг с Grafana и Prometheus

## Содержимое директории

В этой директории содержатся:

- `redis-cache-dashboard.json` - дашборд Grafana для мониторинга Redis кэша
- `system-performance-dashboard.json` - дашборд Grafana для мониторинга производительности системы
- `health-system-dashboard.json` - дашборд Grafana для мониторинга здоровья системы
- `user-activity-dashboard.json` - дашборд Grafana для мониторинга активности пользователей
- `alert-rules.yaml` - правила оповещений для мониторинга
- `README.md` - этот файл, содержащий информацию о настройке мониторинга

## Дашборды

### Redis Cache Dashboard (`redis-cache-dashboard.json`)

Дашборд для мониторинга состояния распределенного кэша Redis, включающий:

- Метрики использования памяти
- Статистику операций (hits/misses)
- Время отклика
- Количество подключений
- Статистику удалений ключей
- Размер очереди команд

### System Performance Dashboard (`system-performance-dashboard.json`)

Дашборд для мониторинга общей производительности системы, включающий:

- Загрузка CPU
- Использование памяти
- Сетевой трафик
- Количество HTTP запросов
- Время ответа API
- Количество ошибок API

### Health System Dashboard (`health-system-dashboard.json`)

Дашборд для мониторинга здоровья системы, включающий:

- Общий показатель здоровья системы
- Показатели здоровья по компонентам (CPU, Memory, API, Cache, Database)
- Тренды изменения показателей здоровья
- Критические события

### User Activity Dashboard (`user-activity-dashboard.json`)

Дашборд для мониторинга активности пользователей, включающий:

- Количество активных пользователей
- Распределение пользовательских операций по типам
- Частота запросов от пользователей
- Статистика успешных и неуспешных операций
- Продолжительность сессий

### Scaling Dashboard (`scaling-dashboard.json`)

Дашборд для мониторинга автоматического масштабирования, включающий:

- Операции масштабирования и их статус
- Информация о правилах масштабирования
- Количество реплик по деплойментам в Kubernetes
- Метрики, используемые для принятия решений о масштабировании
- Статистика ошибок масштабирования

### Database Dashboard (`database-dashboard.json`)

Дашборд для мониторинга производительности базы данных, включающий:

- Обзор базы данных
- Производительность запросов
- Проблемы и размеры таблиц

### database-optimizer-dashboard.json

Дашборд для мониторинга автоматической оптимизации базы данных.

Включает панели для:

- Общее количество и статус рекомендаций по оптимизации
- Метрики эффективности оптимизации
- Распределение рекомендаций по типам (индексы, вакуум, и т.д.)
- Распределение рекомендаций по приоритету
- История оптимизаций
- Влияние оптимизаций на производительность
- Список таблиц, требующих внимания

## Установка и настройка

### Предварительные требования

- Установленный Prometheus
- Установленный Grafana
- Доступ к системе мониторинга

### Шаги по настройке

1. **Установка Prometheus**:

   - Загрузите и установите Prometheus с [официального сайта](https://prometheus.io/download/)
   - Настройте конфигурацию Prometheus (prometheus.yml) для сбора метрик с вашего приложения:

   ```yaml
   scrape_configs:
     - job_name: 'nexus-app'
       metrics_path: '/metrics'
       static_configs:
         - targets: ['localhost:3000']
   ```

2. **Установка Grafana**:

   - Загрузите и установите Grafana с [официального сайта](https://grafana.com/grafana/download)
   - Настройте источник данных Prometheus в Grafana:
     - Откройте Grafana в браузере (по умолчанию http://localhost:3000)
     - Перейдите в "Configuration" -> "Data Sources" -> "Add data source"
     - Выберите Prometheus и укажите URL (обычно http://localhost:9090)
     - Нажмите "Save & Test"

3. **Импорт дашбордов**:

   - В Grafana перейдите в "Create" -> "Import"
   - Загрузите JSON-файлы дашбордов из этой директории
   - Выберите источник данных Prometheus и нажмите "Import"

4. **Настройка алертов**:
   - Импортируйте файл `alert-rules.yaml` в Prometheus
   - Настройте каналы уведомлений в Grafana (Alertmanager)

## Рекомендуемые пороги срабатывания алертов

### Кэширование

- **RedisConnectionLost**: Немедленное оповещение при потере соединения с Redis
- **RedisHighMemoryUsage**: Предупреждение при использовании памяти > 80%, критично при > 90%
- **RedisLowHitRate**: Предупреждение при соотношении hits/misses < 0.7

### Производительность системы

- **HighCpuUsage**: Предупреждение при использовании CPU > 80%, критично при > 90%
- **HighMemoryUsage**: Предупреждение при использовании памяти > 80%, критично при > 90%
- **SlowApiResponses**: Предупреждение при среднем времени ответа > 1000ms, критично при > 3000ms
- **HighErrorRate**: Предупреждение при частоте ошибок > 5%, критично при > 10%

### Здоровье системы

- **LowSystemHealth**: Предупреждение при общем показателе здоровья < 70%, критично при < 50%
- **ComponentHealthCritical**: Критично при показателе здоровья любого компонента < 40%

### Активность пользователей

- **UnusualUserActivity**: Предупреждение при отклонении от среднего числа пользователей > 30%
- **HighFailedOperations**: Предупреждение при количестве неуспешных операций > 10%

### Масштабирование

- **ScalingOperationFailed**: Критично при неудачной операции масштабирования
- **MaxReplicasReached**: Предупреждение при достижении максимального количества реплик
- **ResourceConstraintViolation**: Критично при нарушении ограничений ресурсов при масштабировании

## Описание дашбордов

### Redis Cache Dashboard

Дашборд для мониторинга Redis кэша содержит панели для отображения:

- Скорость обращений к кэшу (hit rate)
- Использование памяти
- Задержки выполнения команд
- Количество подключений
- Соотношение попаданий и промахов кэша

Рекомендуется настроить алерты для кэша с порогами:

- Предупреждение: hit rate < 70%
- Критический: hit rate < 50%

### System Performance Dashboard

Дашборд для мониторинга производительности системы содержит панели для отображения:

- Использование CPU
- Использование памяти
- Частота HTTP запросов
- Время ответа
- Время генерации диалогов
- Операции пользователей

Рекомендуется настроить алерты для производительности с порогами:

- Предупреждение: CPU > 80%, память > 75%, время ответа > 500ms
- Критический: CPU > 90%, память > 85%, время ответа > 1000ms

### Health System Dashboard

Дашборд для мониторинга здоровья системы содержит панели для отображения:

- Общий показатель здоровья системы
- Оценка здоровья инфраструктуры (CPU, память, база данных)
- Оценка здоровья приложения (API, кэш, алерты)
- Текущее состояние компонентов, отображаемое визуально
- Графики использования CPU и памяти с порогами предупреждений и критических значений

Рекомендуется настроить алерты для показателей здоровья с порогами:

- Предупреждение: health score < 70
- Критический: health score < 50

### User Activity Dashboard

Дашборд для мониторинга активности пользователей содержит панели для отображения:

- Пользовательские операции за час (сгруппированные по типам)
- Частота пользовательских операций (операций в секунду)
- Статистика за последние 24 часа (общее количество операций, входов в систему, диалогов)
- ТОП-10 пользовательских операций в табличном виде
- Распределение операций в виде круговой диаграммы
- Активность по различным типам пользователей

Этот дашборд помогает анализировать шаблоны использования приложения, пиковые периоды активности и наиболее часто используемые функции.

### Database Dashboard

Дашборд для мониторинга производительности базы данных содержит панели для отображения:

- Обзор базы данных
- Производительность запросов
- Проблемы и размеры таблиц

## Правила оповещений

В файле `alert-rules.yaml` определены правила для:

### Оповещения Redis кэша:

- `RedisConnectionLost`: Критический алерт при потере соединения с Redis
- `RedisCacheMemoryHigh`: Предупреждение при высоком использовании памяти в Redis

### Оповещения производительности системы:

- `HighCpuUsage`: Предупреждение при высоком использовании CPU
- `HighMemoryUsage`: Предупреждение при высоком использовании памяти
- `HighHttpErrorRate`: Критический алерт при высоком проценте ошибок HTTP
- `SlowHttpResponses`: Предупреждение при медленных ответах HTTP

### Предлагаемые оповещения для базы данных

- `HighDatabaseConnections`: Активируется, когда использование пула соединений превышает 85% более 5 минут
- `DatabaseQueryTime`: Активируется, когда среднее время выполнения запросов превышает 150 мс более 5 минут
- `DatabaseDeadlocks`: Активируется при обнаружении более 2 взаимных блокировок за последний час
- `LowIndexUsage`: Активируется, когда процент использования индексов для любой важной таблицы падает ниже 60% более 30 минут
- `DatabaseConnectionsFull`: КРИТИЧЕСКОЕ - Активируется, когда использование пула соединений достигает 95% и более
- `DatabaseSizeWarning`: Активируется, когда размер любой таблицы растет более чем на 20% за день

Рекомендуется настроить интеграцию с системами оповещений (Slack, Email, PagerDuty)
для своевременного реагирования на проблемы, обнаруженные в системе.
