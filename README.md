# Nexus - AI Character Chat Bot

Проект представляет собой платформу для создания и взаимодействия с AI-персонажами через Telegram. Персонажи имеют реалистичную систему потребностей, мотиваций и действий.

## Особенности

- **Реалистичные характеры персонажей** - каждый персонаж имеет свои потребности, мотивации и эмоциональные состояния
- **Динамическое поведение** - персонажи могут выполнять различные действия, отражающие их текущее состояние
- **Интеграция с Telegram** - взаимодействие с персонажами через популярный мессенджер
- **Система памяти** - персонажи запоминают значимые события и сообщения пользователей
- **Нейросетевой анализ** - использование OpenAI для анализа сообщений пользователя и генерации ответов

## Технический стек

- **Backend**: NestJS, TypeScript
- **База данных**: PostgreSQL
- **ORM**: TypeORM
- **API**: OpenAI API
- **Интеграция**: Telegram Bot API

## Установка и запуск

### Предварительные требования

- Node.js (>= 16.x)
- npm (>= 8.x)
- PostgreSQL (>= 14.x)

### Шаги по установке

1. Клонировать репозиторий:
   ```bash
   git clone https://github.com/yourusername/nexus.git
   cd nexus
   ```

2. Установить зависимости:
   ```bash
   yarn install
   ```

3. Настроить переменные окружения:
   ```bash
   cp .env.example .env
   ```
   Отредактировать `.env` файл, добавив необходимые ключи API и настройки.

4. Создать базу данных в PostgreSQL:
   ```bash
   createdb nexus
   ```

5. Запустить приложение:
   ```bash
   yarn run start:dev
   ```

## Структура проекта

- `src/` - исходный код
  - `character/` - модуль персонажей
    - `entities/` - сущности базы данных
    - `services/` - сервисы для работы с персонажами
    - `controllers/` - контроллеры API
    - `interfaces/` - интерфейсы и типы
  - `telegram/` - модуль интеграции с Telegram
  - `openai/` - модуль работы с OpenAI API
  - `config/` - конфигурация приложения
  - `dialog/` - модуль диалогов
  - `user/` - модуль пользователей

## Настройка конфигурации

В проекте реализована система конфигурации, позволяющая настраивать различные параметры через переменные окружения:

- **Основные настройки**: порт, окружение, уровень логирования
- **База данных**: хост, порт, имя пользователя, пароль
- **OpenAI API**: ключ API, модель, температура
- **Telegram**: токен бота, webhook URL, ID администраторов
- **Персонажи**: интервалы обновления, настройки потребностей, действий и памяти
- **CORS**: настройка разрешенных источников для API запросов (CORS_ORIGIN)

## Оптимизация работы с OpenAI API

В проекте реализованы механизмы для оптимизации взаимодействия с OpenAI API:

### Кэширование запросов

Сервис `OpenAICacheService` предоставляет функционал для кэширования запросов к OpenAI API:
- Снижение количества запросов за счет сохранения ответов для идентичных сообщений
- Экономия токенов и снижение расходов на API
- Ускорение работы приложения за счет мгновенного получения ответов из кэша
- Настраиваемое время жизни кэшированных ответов (TTL)
- Статистика использования кэша (количество попаданий, промахов)

Основные методы сервиса:
- `get<T>(key)` - получение ответа из кэша
- `set<T>(key, value, ttl)` - сохранение ответа в кэш
- `createMessagesHash(messages)` - создание хэша для идентификации сообщений

### Шаблоны промптов

Система шаблонов промптов позволяет управлять подготовкой запросов к OpenAI API:
- Централизованное хранение шаблонов для различных типов запросов
- Подстановка параметров в шаблоны с использованием плейсхолдеров
- Настройка рекомендуемых параметров генерации (температура, количество токенов)
- Систематизация шаблонов по категориям

Реализовано через:
- `PromptTemplateService` - сервис для работы с шаблонами
- Категории шаблонов:
  - `CharacterResponsePrompts` - шаблоны для генерации ответов персонажей
  - `MessageAnalysisPrompts` - шаблоны для анализа сообщений
  - `ActionPrompts` - шаблоны для генерации действий персонажей

Использование:
```typescript
// Пример использования шаблонов
const response = await promptTemplateService.createPrompt('character-response-basic', {
  character,
  userMessage,
  emotionalState,
  dialogHistory
});
```

## Лицензия

MIT

## Тестирование

### Запуск интеграционных тестов с PostgreSQL

Для запуска интеграционных тестов с PostgreSQL выполните следующие шаги:

1. **Запустите тестовую базу данных:**
   ```bash
   docker compose -f docker-compose.test.yml up -d
   ```

2. **Запустите интеграционные тесты:**
   ```bash
   yarn test:integration
   ```

3. **Запуск конкретного теста:**
   ```bash
   yarn test:integration -- --testNamePattern="название теста"
   ```

4. **Запуск всех тестов:**
   ```bash
   yarn test:all
   ```

5. **Остановка тестовых сервисов:**
   ```bash
   docker compose -f docker-compose.test.yml down
   ```

### Типы тестов

- **Unit тесты** - используют SQLite в памяти: `yarn test`
- **Интеграционные тесты** - используют PostgreSQL в Docker: `yarn test:integration`

### Конфигурация

- Тестовая конфигурация: `.env.test`
- Docker compose для тестов: `docker-compose.test.yml`
- Jest конфигурация: `jest.integration.config.js`
